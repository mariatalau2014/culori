<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Joc MatematicƒÉ: Debug Activ</title>
<style>
/* ... (Toate stilurile anterioare rƒÉm√¢n la fel) ... */
:root {
--boy-bg: #E3F2FD; --boy-primary: #2196F3; --boy-secondary: #4FC3F7; --boy-accent: #4CAF50;
--girl-bg: #FCE4EC; --girl-primary: #EC407A; --girl-secondary: #F48FB1; --girl-accent: #AB47BC;
--pro-bg: #263238; --pro-card: #37474F; --pro-text: #ECEFF1; --pro-accent: #00E5FF;
--text-color: #455A64; --card-bg: #FFFFFF; --success: #66BB6A; --error: #EF5350;
--timer-warning: #FF9800; --timer-danger: #F44336; --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32;
}
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; user-select: none; }
body { background-color: var(--girl-bg); background-image: radial-gradient(#F8BBD0 15%, transparent 16%), radial-gradient(#F8BBD0 15%, transparent 16%); background-size: 60px 60px; background-position: 0 0, 30px 30px; color: var(--text-color); min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-x: hidden; transition: background 0.5s ease; position: relative; }
body.boy-theme { background-color: var(--boy-bg); background-image: radial-gradient(#BBDEFB 15%, transparent 16%), radial-gradient(#BBDEFB 15%, transparent 16%); }
body.pro-theme { background-color: var(--pro-bg); background-image: radial-gradient(#455A64 15%, transparent 16%); color: var(--pro-text); }
.background-shapes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
.shape { position: absolute; opacity: 0.4; animation: float 15s infinite linear; }
@keyframes float { 0% { transform: translateY(100vh) rotate(0deg); } 100% { transform: translateY(-100px) rotate(360deg); } }
.container { width: 90%; max-width: 900px; text-align: center; padding: 2rem; position: relative; z-index: 1; }
h1 { font-size: 2.8rem; margin-bottom: 2rem; color: var(--girl-primary); text-shadow: 2px 2px 0px #FFF; transition: color 0.5s; }
body.boy-theme h1 { color: var(--boy-primary); text-shadow: none; }
body.pro-theme h1 { color: var(--pro-accent); text-shadow: 0 0 10px rgba(0, 229, 255, 0.5); }
body.boy-theme h2 { color: var(--boy-primary); }
body.pro-theme h2 { color: var(--pro-accent); }
h2 { margin-bottom: 1.5rem; font-size: 2rem; }
.menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; width: 100%; }
.card { background: var(--card-bg); border-radius: 25px; padding: 1.5rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 8px 0 rgba(0,0,0,0.1); border: 4px solid #FFF; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; position: relative; }
body.pro-theme .card { background: var(--pro-card); color: var(--pro-text); border: 2px solid var(--pro-accent); }
.card:hover { transform: translateY(-8px) scale(1.03); box-shadow: 0 15px 0 rgba(0,0,0,0.1); }
.card.kg-card { border-bottom: 6px solid var(--boy-accent); }
.card.easy-card { border-bottom: 6px solid var(--girl-secondary); }
.card.max-card { border-bottom: 6px solid var(--girl-primary); }
.card.med-card { border-bottom: 6px solid var(--girl-accent); }
.card.hard-card { border-bottom: 6px solid var(--girl-primary); }
.card.pro-card { border-bottom: 6px solid var(--pro-accent); }
.card-icon { font-size: 3.5rem; margin-bottom: 1rem; }
.card-title { font-weight: 900; font-size: 1.4rem; margin-bottom: 0.5rem; }
body.pro-theme .card-title { color: var(--pro-text); }
body:not(.pro-theme) .card-title { color: var(--text-color); }
.card-desc { font-size: 0.9rem; line-height: 1.4; font-weight: 600; }
body.pro-theme .card-desc { color: #B0BEC5; }
body:not(.pro-theme) .card-desc { color: #78909C; }
.card-lb-btn { position: absolute; top: 10px; right: 10px; background: var(--gold); color: #fff; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 0 #B8860B; transition: transform 0.2s; z-index: 5; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.card-lb-btn:hover { transform: scale(1.1); }
.card-lb-btn:active { transform: scale(0.95); box-shadow: 0 2px 0 #B8860B; }
.game-area { display: none; background: var(--card-bg); border-radius: 30px; padding: 2.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 600px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 5px solid var(--girl-secondary); transition: border-color 0.5s, background 0.5s, color 0.5s; }
body.boy-theme .game-area { border-color: var(--boy-secondary); }
body.pro-theme .game-area { border-color: var(--pro-accent); background: var(--pro-card); color: var(--pro-text); }
@keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
.stats-bar { display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 1.3rem; font-weight: 800; color: var(--girl-primary); background: #F8BBD0; padding: 10px 20px; border-radius: 50px; transition: all 0.5s; }
body.boy-theme .stats-bar { color: var(--boy-primary); background: #BBDEFB; }
body.pro-theme .stats-bar { color: var(--pro-bg); background: var(--pro-accent); }
.timer-container { width: 100%; height: 15px; background-color: #eee; border-radius: 10px; margin-bottom: 1.5rem; overflow: hidden; border: 2px solid #ddd; }
.timer-bar { height: 100%; width: 100%; background-color: var(--success); transition: width 1s linear, background-color 0.5s; }
.visual-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 20px 0; min-height: 80px; align-items: center; }
.ball { width: 45px; height: 45px; border-radius: 50%; box-shadow: inset -3px -3px 10px rgba(0,0,0,0.1), 3px 3px 5px rgba(0,0,0,0.15); animation: bounce 2s infinite ease-in-out; border: 2px solid rgba(255,255,255,0.3); }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
.sequence-display { font-size: 3.5rem; font-weight: 900; letter-spacing: 5px; margin: 20px 0; }
body:not(.pro-theme) .sequence-display { color: var(--text-color); }
body.pro-theme .sequence-display { color: var(--pro-text); }
.missing-number { color: var(--girl-primary); border-bottom: 4px dashed var(--girl-primary); padding: 0 10px; }
body.boy-theme .missing-number { color: var(--boy-primary); border-bottom-color: var(--boy-primary); }
body.pro-theme .missing-number { color: var(--pro-accent); border-bottom-color: var(--pro-accent); }
.problem-display { font-size: 4rem; font-weight: 900; margin: 1rem 0; color: var(--girl-primary); transition: color 0.5s; }
body.boy-theme .problem-display { color: var(--boy-primary); }
body.pro-theme .problem-display { color: var(--pro-accent); }
.input-group { display: flex; gap: 1rem; justify-content: center; margin-bottom: 1.5rem; }
input[type="number"], input[type="text"] { width: 130px; padding: 0.8rem; font-size: 2.2rem; text-align: center; border: 3px solid var(--girl-secondary); border-radius: 20px; outline: none; transition: all 0.3s; font-family: inherit; background: #FFF; }
body.pro-theme input[type="number"], body.pro-theme input[type="text"] { border-color: var(--pro-accent); background: #263238; color: white; }
body:not(.pro-theme) input[type="number"] { color: var(--text-color); }
input[type="number"]:focus, input[type="text"]:focus { border-color: var(--girl-primary); transform: scale(1.05); }
body.boy-theme input[type="number"]:focus { border-color: var(--boy-primary); }
body.pro-theme input[type="number"]:focus { border-color: var(--pro-accent); }
input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
input[type=number] { -moz-appearance: textfield; }
.choices-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 2rem; }
.choice-btn { background: white; border: 4px solid var(--boy-secondary); border-radius: 20px; padding: 1.5rem; font-size: 2rem; font-weight: 900; color: var(--boy-primary); cursor: pointer; transition: all 0.2s; box-shadow: 0 6px 0 #0277BD; font-family: inherit; }
.choice-btn:active { transform: translateY(6px); box-shadow: none; }
.choice-btn:hover { background: #E1F5FE; }
.btn { padding: 1rem 2rem; font-size: 1.3rem; border: none; border-radius: 50px; cursor: pointer; font-weight: 900; transition: all 0.2s; color: white; font-family: inherit; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 5px 0 rgba(0,0,0,0.1); }
.btn:active { transform: translateY(4px); box-shadow: none; }
.btn-primary { background-color: var(--girl-primary); box-shadow: 0 5px 0 #C2185B; transition: background 0.5s, box-shadow 0.5s; }
body.boy-theme .btn-primary { background-color: var(--boy-primary); box-shadow: 0 5px 0 #1565C0; }
body.pro-theme .btn-primary { background-color: var(--pro-accent); color: var(--pro-bg); box-shadow: 0 5px 0 #00B8D4; }
.btn-secondary { background-color: #B0BEC5; box-shadow: 0 5px 0 #78909C; margin-top: 1rem; font-size: 1rem; padding: 0.8rem 1.5rem; }
.feedback { height: 3rem; margin-top: 1rem; font-weight: 900; font-size: 1.3rem; line-height: 1.4; }
.feedback.correct { color: var(--success); }
.feedback.wrong { color: var(--error); }
.back-btn { position: absolute; top: 20px; left: 20px; background: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; z-index: 10; font-family: inherit; color: var(--girl-primary); transition: all 0.5s; }
body.boy-theme .back-btn { color: var(--boy-primary); }
body.pro-theme .back-btn { color: var(--pro-bg); background: var(--pro-accent); }
.back-btn:hover { transform: scale(1.1); }
.award-container, .leaderboard-container { display: none; flex-direction: column; align-items: center; justify-content: center; animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); background: white; padding: 2rem; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-width: 500px; margin: 0 auto; }
.award-icon { font-size: 8rem; margin: 1rem 0; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2)); animation: float 3s infinite ease-in-out; }
.award-title { font-size: 3rem; font-weight: 900; margin-bottom: 1rem; text-transform: uppercase; }
.award-gold { color: var(--gold); text-shadow: 2px 2px 0 #B8860B; }
.award-silver { color: var(--silver); text-shadow: 2px 2px 0 #78909C; }
.award-bronze { color: var(--bronze); text-shadow: 2px 2px 0 #8D6E63; }
.award-mention { color: var(--boy-primary); text-shadow: 2px 2px 0 #1565C0; }
.award-try { color: var(--error); text-shadow: 2px 2px 0 #C62828; }
.final-score { font-size: 2rem; color: var(--text-color); margin-bottom: 1rem; font-weight: bold; }
.name-input-group { margin: 1.5rem 0; display: flex; flex-direction: column; gap: 10px; align-items: center; }
.name-input-group label { font-size: 1.2rem; font-weight: bold; color: var(--text-color); }
.name-input-group input { width: 100%; font-size: 1.5rem; padding: 0.5rem; }
.leaderboard-table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 1.1rem; }
.leaderboard-table th { background: var(--girl-primary); color: white; padding: 10px; border-radius: 10px 10px 0 0; }
body.pro-theme .leaderboard-table th { background: var(--pro-accent); color: var(--pro-bg); }
body.boy-theme .leaderboard-table th { background: var(--boy-primary); }
.leaderboard-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
.leaderboard-table tr:nth-child(even) { background-color: #f9f9f9; }
.leaderboard-table tr:first-child td { font-weight: bold; color: var(--gold); }
.leaderboard-table tr:nth-child(2) td { font-weight: bold; color: var(--silver); }
.leaderboard-table tr:nth-child(3) td { font-weight: bold; color: var(--bronze); }

/* NOU: Stiluri pentru afi»ôarea erorilor pe ecran */
#error-overlay {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: #ffebee;
    border-top: 4px solid #ef5350;
    color: #c62828;
    padding: 15px;
    font-family: monospace;
    font-size: 14px;
    z-index: 9999;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
    text-align: left;
    max-height: 200px;
    overflow-y: auto;
}
#error-overlay h3 { margin-bottom: 5px; font-size: 16px; text-transform: uppercase; }
#error-overlay ul { list-style: none; padding-left: 0; margin: 0; }
#error-overlay li { margin-bottom: 5px; border-bottom: 1px solid #ffcdd2; padding-bottom: 5px; }
.close-error { float: right; cursor: pointer; font-weight: bold; border: 1px solid #c62828; padding: 2px 8px; border-radius: 4px; }
.close-error:hover { background: #c62828; color: white; }

@media (max-width: 600px) {
h1 { font-size: 2rem; }
.problem-display { font-size: 3rem; }
.menu-grid { grid-template-columns: 1fr; }
.card { min-height: 160px; }
.choices-grid { grid-template-columns: 1fr; }
.award-icon { font-size: 6rem; }
.award-title { font-size: 2rem; }
}
</style>
</head>
<body>

<!-- NOU: Container pentru afi»ôarea erorilor -->
<div id="error-overlay">
    <span class="close-error" onclick="document.getElementById('error-overlay').style.display='none'">X √énchide</span>
    <h3>‚ö†Ô∏è Erori detectate:</h3>
    <ul id="error-list"></ul>
</div>

<div class="background-shapes" id="bg-shapes"></div>
<button class="back-btn" id="backBtn" style="display: none;" onclick="showMenu()">‚Üê √énapoi</button>
<div class="container">
<div id="mainMenu">
<h1>Jocuri Matematice (20 Ex)</h1>
<div class="menu-grid" id="mainMenuGrid"></div>
</div>
<div id="subMenu" style="display: none;">
<h2 id="subMenuTitle">Alege activitatea:</h2>
<div class="menu-grid" id="subMenuGrid"></div>
<button class="btn btn-secondary" onclick="showMenu()" style="margin-top: 2rem;">√énapoi la Meniu</button>
</div>
<div id="gameArea" class="game-area">
<div class="stats-bar">
<span id="scoreDisplay">Scor: 100</span>
<span id="progressDisplay">Exerci»õiul: 1/20</span>
</div>
<div class="timer-container"><div class="timer-bar" id="timerBar"></div></div>
<div id="gameContent"></div>
<div id="choicesContainer" class="choices-grid" style="display: none;"></div>
<div id="inputContainer" class="input-group" style="display: none;">
<input type="number" id="answerInput" placeholder="?" autocomplete="off" step="0.1">
<button class="btn btn-primary" onclick="checkAnswer()">VerificƒÉ</button>
</div>
<div class="feedback" id="feedbackText"></div>
<button class="btn btn-secondary" onclick="showMenu()">Ie»ôire</button>
</div>
<div id="awardScreen" class="award-container">
<div class="award-icon" id="awardIcon">üèÜ</div>
<div class="award-title" id="awardTitle">Premiul 1</div>
<div class="final-score" id="finalScoreText">Scor Final: 100</div>
<div class="name-input-group" id="nameInputGroup" style="display: none;">
<label for="playerName">Introdu numele tƒÉu:</label>
<input type="text" id="playerName" placeholder="Nume..." maxlength="15">
<button class="btn btn-primary" onclick="saveScore()">SalveazƒÉ Scorul</button>
</div>
<button class="btn btn-secondary" id="closeAwardBtn" onclick="showMenu()" style="display: none;">√énapoi la Meniu</button>
</div>
<div id="leaderboardScreen" class="leaderboard-container">
<h2 id="leaderboardTitle">Clasament</h2>
<table class="leaderboard-table">
<thead><tr><th>#</th><th>Nume</th><th>Scor</th></tr></thead>
<tbody id="leaderboardBody"></tbody>
</table>
<button class="btn btn-secondary" onclick="showMenu()">√énapoi</button>
</div>
</div>

<script>
// --- Sistem de capturare erori ---
const errorList = document.getElementById('error-list');
const errorOverlay = document.getElementById('error-overlay');
let errorCount = 0;

window.onerror = function(message, source, lineno, colno, error) {
    const li = document.createElement('li');
    li.textContent = `${message} (Linia: ${lineno})`;
    errorList.appendChild(li);
    errorOverlay.style.display = 'block';
    errorCount++;
    if(errorCount > 5) {
        const warning = document.createElement('li');
        warning.textContent = "... »ôi alte erori. VerificƒÉ consola (F12).";
        warning.style.fontStyle = "italic";
        errorList.appendChild(warning);
    }
    return true; // Previne comportamentul default al browserului dacƒÉ e necesar
};

// --- Game State ---
let currentMode = '';
let score = 100;
let currentAnswer = 0;
let timeLeft = 0;
let maxTime = 0;
let timerInterval;
let difficultyLevel = 1;
let problemHTML = '';
let questionCount = 0;
const MAX_QUESTIONS = 20;
let currentSubMenuKey = '';

// --- DOM Elements ---
const mainMenu = document.getElementById('mainMenu');
const mainMenuGrid = document.getElementById('mainMenuGrid');
const subMenu = document.getElementById('subMenu');
const subMenuTitle = document.getElementById('subMenuTitle');
const subMenuGrid = document.getElementById('subMenuGrid');
const gameArea = document.getElementById('gameArea');
const awardScreen = document.getElementById('awardScreen');
const leaderboardScreen = document.getElementById('leaderboardScreen');
const leaderboardBody = document.getElementById('leaderboardBody');
const leaderboardTitle = document.getElementById('leaderboardTitle');
const awardIcon = document.getElementById('awardIcon');
const awardTitle = document.getElementById('awardTitle');
const finalScoreText = document.getElementById('finalScoreText');
const nameInputGroup = document.getElementById('nameInputGroup');
const playerNameInput = document.getElementById('playerName');
const closeAwardBtn = document.getElementById('closeAwardBtn');
const backBtn = document.getElementById('backBtn');
const gameContent = document.getElementById('gameContent');
const answerInput = document.getElementById('answerInput');
const feedbackText = document.getElementById('feedbackText');
const scoreDisplay = document.getElementById('scoreDisplay');
const progressDisplay = document.getElementById('progressDisplay');
const timerBar = document.getElementById('timerBar');
const choicesContainer = document.getElementById('choicesContainer');
const inputContainer = document.getElementById('inputContainer');
const body = document.body;

const menus = {
'kg': { title: 'GrƒÉdini»õƒÉ', theme: 'boy', items: [
{ id: 'kg_count', icon: 'üöó', title: 'NumƒÉrƒÉ Obiecte', desc: 'C√¢te ma»ôinu»õe sunt?' },
{ id: 'kg_sequence', icon: 'ü§ñ', title: '»òir Numeric', desc: 'ContinuƒÉ »ôirul (1-10)' },
{ id: 'kg_add', icon: '‚öΩ', title: 'AdunƒÉri Vizuale', desc: 'AdunƒÉ bilele' }
]},
'easy_menu': { title: 'Clasa 1 - 2 (FƒÉrƒÉ Trecere)', theme: 'girl', items: [
{ id: 'easy_math', icon: 'ü¶Ñ', title: 'Calcule', desc: 'AdunƒÉri »ôi scƒÉderi simple' },
{ id: 'easy_seq', icon: 'üî¢', title: '»òiruri Numerice', desc: 'GƒÉse»ôte urmƒÉtorul numƒÉr' },
{ id: 'easy_comp', icon: '‚öñÔ∏è', title: 'Compara»õii', desc: 'Care e mai mare?' }
]},
'max_menu': { title: 'Clasa 1 - 2 (Cu Trecere)', theme: 'girl', items: [
{ id: 'max_math', icon: 'üëë', title: 'Calcule Avansate', desc: 'Cu trecere peste ordin' },
{ id: 'max_seq', icon: 'üß©', title: '»òiruri Complexe', desc: 'Salturi de 2, 5, 10' },
{ id: 'max_eq', icon: '‚ùì', title: 'Ecua»õii Simple', desc: 'GƒÉse»ôte numƒÉrul lipsƒÉ' }
]},
'med_menu': { title: 'Clasa 3 - 4', theme: 'girl', items: [
{ id: 'med_math', icon: 'üå∏', title: '√énmul»õiri & √émpƒÉr»õiri', desc: 'Tabelele √Ænmul»õirii' },
{ id: 'med_round', icon: 'üéØ', title: 'Rotunjiri', desc: 'La zece sau sutƒÉ' },
{ id: 'med_order', icon: 'üìù', title: 'Ordinea Opera»õiilor', desc: 'Calcul cu paranteze' }
]},
'hard_menu': { title: 'Clasa 5+', theme: 'girl', items: [
{ id: 'hard_frac', icon: 'üç∞', title: 'Frac»õii', desc: 'AdunƒÉri cu frac»õii' },
{ id: 'hard_dec', icon: 'üíß', title: 'Zecimale', desc: 'Calcule cu virgulƒÉ' },
{ id: 'hard_pow', icon: '‚ö°', title: 'Puteri & Radicali', desc: 'Calcul avansat' }
]},
'pro_menu': { title: '5 Pro (Avansat)', theme: 'pro', items: [
{ id: 'pro_cong', icon: '‚öõÔ∏è', title: 'Congruen»õe', desc: 'AritmeticƒÉ modularƒÉ (mod n)' },
{ id: 'pro_last', icon: 'üî¢', title: 'Ultima CifrƒÉ', desc: 'DeterminƒÉ ultima cifrƒÉ' },
{ id: 'pro_div', icon: '‚ûó', title: 'Criterii Divizibilitate', desc: 'Restul √ÆmpƒÉr»õirii' }
]}
};

function init() {
createBackgroundShapes();
renderMainMenu();
answerInput.addEventListener("keypress", function(event) {
if (event.key === "Enter") checkAnswer();
});
}

function createBackgroundShapes() {
const container = document.getElementById('bg-shapes');
const colors = ['#FFCC80', '#FFAB91', '#FFE082', '#A5D6A7', '#90CAF9'];
for(let i=0; i<12; i++) {
const shape = document.createElement('div');
shape.classList.add('shape');
const size = Math.random() * 60 + 30;
const color = colors[Math.floor(Math.random() * colors.length)];
shape.style.width = `${size}px`;
shape.style.height = `${size}px`;
shape.style.left = `${Math.random() * 100}%`;
shape.style.backgroundColor = color;
shape.style.borderRadius = Math.random() > 0.5 ? '50%' : '15%';
shape.style.animationDuration = `${Math.random() * 10 + 15}s`;
shape.style.animationDelay = `-${Math.random() * 20}s`;
container.appendChild(shape);
}
}

function renderMainMenu() {
mainMenuGrid.innerHTML = '';
Object.keys(menus).forEach(key => {
const menuData = menus[key];
const card = document.createElement('div');
card.className = `card ${menuData.theme === 'boy' ? 'kg-card' : (menuData.theme === 'pro' ? 'pro-card' : 'easy-card')}`;
const lbBtn = document.createElement('button');
lbBtn.className = 'card-lb-btn';
lbBtn.innerHTML = 'üèÜ';
lbBtn.title = 'Vezi Clasament';
lbBtn.onclick = (e) => { e.stopPropagation(); showLeaderboard(key); };
card.innerHTML = `<div class="card-icon">${menuData.items[0].icon}</div><div class="card-title">${menuData.title}</div><div class="card-desc">${menuData.items[0].desc}</div>`;
card.appendChild(lbBtn);
card.onclick = () => openSubmenu(key);
mainMenuGrid.appendChild(card);
});
}

function showMenu() {
clearInterval(timerInterval);
mainMenu.style.display = 'block';
subMenu.style.display = 'none';
gameArea.style.display = 'none';
awardScreen.style.display = 'none';
leaderboardScreen.style.display = 'none';
backBtn.style.display = 'none';
answerInput.value = '';
body.classList.remove('boy-theme', 'pro-theme');
}

function openSubmenu(menuKey) {
currentSubMenuKey = menuKey;
const menuData = menus[menuKey];
if(!menuData) return;
mainMenu.style.display = 'none';
subMenu.style.display = 'block';
backBtn.style.display = 'flex';
backBtn.onclick = showMenu;
subMenuTitle.textContent = menuData.title;
subMenuGrid.innerHTML = '';
body.classList.remove('boy-theme', 'pro-theme');
if(menuData.theme === 'boy') body.classList.add('boy-theme');
if(menuData.theme === 'pro') body.classList.add('pro-theme');
menuData.items.forEach(item => {
const card = document.createElement('div');
card.className = `card ${menuData.theme === 'boy' ? 'kg-card' : (menuData.theme === 'pro' ? 'pro-card' : 'easy-card')}`;
card.innerHTML = `<div class="card-icon">${item.icon}</div><div class="card-title">${item.title}</div><div class="card-desc">${item.desc}</div>`;
card.onclick = () => startGame(item.id);
subMenuGrid.appendChild(card);
});
}

function startGame(mode) {
currentMode = mode;
score = 100;
questionCount = 0;
difficultyLevel = 1;
updateStats();
subMenu.style.display = 'none';
gameArea.style.display = 'block';
awardScreen.style.display = 'none';
leaderboardScreen.style.display = 'none';
backBtn.style.display = 'flex';
const isBoy = mode.startsWith('kg');
const isPro = mode.startsWith('pro');
if(isBoy) {
body.classList.add('boy-theme');
choicesContainer.style.display = 'grid';
inputContainer.style.display = 'none';
backBtn.onclick = () => { clearInterval(timerInterval); gameArea.style.display = 'none'; subMenu.style.display = 'block'; };
} else {
if(isPro) body.classList.add('pro-theme');
else body.classList.remove('boy-theme', 'pro-theme');
choicesContainer.style.display = 'none';
inputContainer.style.display = 'flex';
backBtn.onclick = () => { clearInterval(timerInterval); gameArea.style.display = 'none'; subMenu.style.display = 'block'; };
}
nextProblem();
if(!isBoy) answerInput.focus();
}

function updateStats() {
scoreDisplay.textContent = `Scor: ${score}`;
progressDisplay.textContent = `Exerci»õiul: ${questionCount + 1}/${MAX_QUESTIONS}`;
}

function startTimer(seconds) {
clearInterval(timerInterval);
maxTime = seconds;
timeLeft = seconds;
updateTimerVisuals();
timerInterval = setInterval(() => {
timeLeft--;
updateTimerVisuals();
if (timeLeft <= 0) { clearInterval(timerInterval); handleTimeout(); }
}, 1000);
}

function updateTimerVisuals() {
const percentage = (timeLeft / maxTime) * 100;
timerBar.style.width = `${percentage}%`;
if (percentage > 50) timerBar.style.backgroundColor = 'var(--success)';
else if (percentage > 20) timerBar.style.backgroundColor = 'var(--timer-warning)';
else timerBar.style.backgroundColor = 'var(--timer-danger)';
}

function handleTimeout() { showCorrectAnswer(); }
function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function generateChoices(correctAnswer, minVal, maxVal) {
let choices = new Set();
choices.add(correctAnswer);
while(choices.size < 3) {
let offset = getRandomInt(-5, 5);
let wrong = correctAnswer + offset;
if(wrong >= minVal && wrong <= maxVal && wrong !== correctAnswer) choices.add(wrong);
else { let r = getRandomInt(minVal, maxVal); if(r !== correctAnswer) choices.add(r); }
}
return Array.from(choices).sort(() => Math.random() - 0.5);
}

function renderChoices(choices) {
choicesContainer.innerHTML = '';
choices.forEach(val => {
const btn = document.createElement('button');
btn.className = 'choice-btn';
btn.textContent = val;
btn.onclick = () => handleChoiceClick(val);
choicesContainer.appendChild(btn);
});
}

function handleChoiceClick(val) {
if(questionCount >= MAX_QUESTIONS) return;
if(val === currentAnswer) {
feedbackText.textContent = "Bravo! Corect! üéâ";
feedbackText.className = "feedback correct";
difficultyLevel = 1;
setTimeout(nextProblem, 1500);
} else {
score -= 5;
updateStats();
feedbackText.textContent = "Gre»ôit! -5 puncte. üò¢";
feedbackText.className = "feedback wrong";
difficultyLevel++;
setTimeout(nextProblem, 1500);
}
}

function nextProblem() {
if (questionCount >= MAX_QUESTIONS) { endGame(); return; }
questionCount++;
updateStats();
answerInput.value = '';
feedbackText.textContent = '';
feedbackText.className = 'feedback';
gameContent.innerHTML = '';
choicesContainer.innerHTML = '';

if (currentMode.startsWith('kg')) { if (difficultyLevel === 1) startTimer(30); else startTimer(40); } 
else { if (difficultyLevel === 1) startTimer(20); else startTimer(30); }

// Logica generare probleme (identicƒÉ cu cea originalƒÉ)
if (currentMode === 'kg_count') {
const maxCount = difficultyLevel === 1 ? 5 : 10;
const count = getRandomInt(1, maxCount);
currentAnswer = count;
let html = '<div class="visual-container">';
const icons = ['üöó', '‚öΩ', 'üöÄ', 'ü§ñ', 'üö≤'];
const icon = icons[Math.floor(Math.random() * icons.length)];
for(let i=0; i<count; i++) html += `<div style="font-size: 3rem; animation: bounce 2s infinite; animation-delay: ${i*0.1}s">${icon}</div>`;
html += '</div><p style="font-size: 1.3rem; color: #546E7A; font-weight:bold;">C√¢te sunt?</p>';
gameContent.innerHTML = html;
renderChoices(generateChoices(currentAnswer, 1, maxCount + 2));
}
else if (currentMode === 'kg_sequence') {
const start = getRandomInt(0, difficultyLevel === 1 ? 3 : 6);
let sequence = [];
for(let i=0; i<3; i++) sequence.push(start + i);
currentAnswer = start + 3;
gameContent.innerHTML = `<p style="font-size: 1.3rem; color: #546E7A; font-weight:bold;">CompleteazƒÉ codul:</p><div class="sequence-display">${sequence.join(' , ')} , <span class="missing-number">?</span></div>`;
renderChoices(generateChoices(currentAnswer, 0, 10));
}
else if (currentMode === 'kg_add') {
const maxNum = difficultyLevel === 1 ? 4 : 9;
const n1 = getRandomInt(1, maxNum);
const n2 = getRandomInt(1, maxNum);
currentAnswer = n1 + n2;
let html = '<div class="visual-container">';
for(let i=0; i<n1; i++) html += `<div style="font-size: 2.5rem;">‚öΩ</div>`;
html += '<div style="width:20px; font-weight:900; color:#2196F3; font-size:1.5rem;">+</div>';
for(let i=0; i<n2; i++) html += `<div style="font-size: 2.5rem;">‚öΩ</div>`;
html += '</div>';
gameContent.innerHTML = html + `<div class="problem-display">${n1} + ${n2} = ?</div>`;
renderChoices(generateChoices(currentAnswer, 2, maxNum * 2 + 2));
}
else if (currentMode === 'easy_math') {
const rangeMax = difficultyLevel === 1 ? 50 : 90;
const op = Math.random() > 0.5 ? '+' : '-';
let n1 = getRandomInt(10, rangeMax);
let n2;
if(op === '+') {
let d1_10 = Math.floor(n1 / 10); let d1_1 = n1 % 10;
let d2_10 = getRandomInt(0, 9 - d1_10); let d2_1 = getRandomInt(0, 9 - d1_1);
n2 = (d2_10 * 10) + d2_1; if(n2===0) n2=1;
currentAnswer = n1 + n2;
} else {
let d1_10 = Math.floor(n1 / 10); let d1_1 = n1 % 10;
let d2_10 = getRandomInt(0, d1_10); let d2_1 = getRandomInt(0, d1_1);
n2 = (d2_10 * 10) + d2_1; if(n2===0) n2=1; if(n2 >= n1) n2 = getRandomInt(1, n1-1);
currentAnswer = n1 - n2;
}
problemHTML = `<div class="problem-display">${n1} ${op} ${n2} = ?</div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'easy_seq') {
const start = getRandomInt(1, 20);
const step = 1;
let seq = [start, start+step, start+step*2];
currentAnswer = start + step*3;
problemHTML = `<div class="sequence-display">${seq.join(', ')}, <span class="missing-number">?</span></div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'easy_comp') {
const n1 = getRandomInt(10, 50);
const n2 = getRandomInt(10, 50);
currentAnswer = n1 > n2 ? 1 : 2;
problemHTML = `<div style="font-size:1.5rem; color:#666;">ComparƒÉ numerele:</div><div class="problem-display">${n1} <span class="missing-number">?</span> ${n2}</div><div style="font-size:1.2rem; color:#666;">(1 st√¢nga, 2 dreapta)</div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'max_math') {
const op = Math.random() > 0.5 ? '+' : '-';
let n1, n2;
if(op === '+') {
let u1 = getRandomInt(1, 9); let u2 = getRandomInt(10-u1, 9);
let t1 = getRandomInt(1, 8); let t2 = getRandomInt(0, 9-t1);
n1 = t1*10+u1; n2 = t2*10+u2; currentAnswer = n1+n2;
} else {
let u1 = getRandomInt(0, 8); let u2 = getRandomInt(u1+1, 9);
let t1 = getRandomInt(2, 9); let t2 = getRandomInt(0, t1-1);
n1 = t1*10+u1; n2 = t2*10+u2; currentAnswer = n1-n2;
}
problemHTML = `<div class="problem-display">${n1} ${op} ${n2} = ?</div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'max_seq') {
const step = difficultyLevel === 1 ? 2 : 5;
const start = getRandomInt(1, 10);
let seq = [start, start+step, start+step*2];
currentAnswer = start + step*3;
problemHTML = `<div class="sequence-display">${seq.join(', ')}, <span class="missing-number">?</span></div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'max_eq') {
const res = getRandomInt(10, 50);
const add = getRandomInt(1, 9);
currentAnswer = res - add;
problemHTML = `<div class="problem-display"><span class="missing-number">?</span> + ${add} = ${res}</div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'med_math') {
const n1 = getRandomInt(2, 9);
const n2 = getRandomInt(2, 9);
currentAnswer = n1 * n2;
problemHTML = `<div class="problem-display">${n1} √ó ${n2} = ?</div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'med_round') {
const num = getRandomInt(15, 985);
const roundTo = difficultyLevel === 1 ? 10 : 100;
currentAnswer = Math.round(num / roundTo) * roundTo;
problemHTML = `<div style="font-size:1.5rem; color:#666;">Rotunjire la ${roundTo}:</div><div class="problem-display">${num} ‚âà <span class="missing-number">?</span></div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'med_order') {
const a = getRandomInt(2, 5);
const b = getRandomInt(2, 5);
const c = getRandomInt(1, 10);
currentAnswer = (a + b) * c;
problemHTML = `<div class="problem-display">(${a} + ${b}) √ó ${c} = ?</div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'hard_frac') {
const den = getRandomInt(2, 9);
const n1 = getRandomInt(1, den-1);
const n2 = getRandomInt(1, den-n1);
currentAnswer = (n1 + n2) / den;
problemHTML = `<div style="font-size:1.5rem; color:#666;">Calcul (zecimal):</div><div class="problem-display">${n1}/${den} + ${n2}/${den} = <span class="missing-number">?</span></div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'hard_dec') {
const n1 = getRandomInt(10, 50) / 10;
const n2 = getRandomInt(10, 50) / 10;
currentAnswer = n1 + n2;
problemHTML = `<div class="problem-display">${n1} + ${n2} = <span class="missing-number">?</span></div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'hard_pow') {
const base = getRandomInt(2, 5);
const exp = getRandomInt(2, 3);
currentAnswer = Math.pow(base, exp);
problemHTML = `<div class="problem-display">${base}<sup>${exp}</sup> = <span class="missing-number">?</span></div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'pro_cong') {
const n = difficultyLevel === 1 ? getRandomInt(2, 5) : getRandomInt(6, 12);
const a = getRandomInt(10, 100);
currentAnswer = a % n;
problemHTML = `<div style="font-size:1.5rem; color:#666;">Congruen»õƒÉ:</div><div class="problem-display">${a} ‚â° <span class="missing-number">?</span> (mod ${n})</div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'pro_last') {
const base = getRandomInt(11, 99);
const exp = getRandomInt(2, 5);
currentAnswer = Math.pow(base, exp) % 10;
problemHTML = `<div style="font-size:1.5rem; color:#666;">Ultima cifrƒÉ:</div><div class="problem-display">${base}<sup>${exp}</sup> ‚Üí <span class="missing-number">?</span></div>`;
gameContent.innerHTML = problemHTML;
}
else if (currentMode === 'pro_div') {
const div = difficultyLevel === 1 ? 3 : 7;
const a = getRandomInt(20, 100);
currentAnswer = a % div;
problemHTML = `<div style="font-size:1.5rem; color:#666;">Restul √ÆmpƒÉr»õirii:</div><div class="problem-display">${a} : ${div} rest <span class="missing-number">?</span></div>`;
gameContent.innerHTML = problemHTML;
}
}

function endGame() {
clearInterval(timerInterval);
gameArea.style.display = 'none';
awardScreen.style.display = 'flex';
finalScoreText.textContent = `Scor Final: ${score}`;
let icon = '', title = '', titleClass = '', showInput = false;
if (score === 100) { icon = 'üèÜ'; title = 'PREMIUL 1'; titleClass = 'award-gold'; showInput = true; } 
else if (score === 95) { icon = 'ü•à'; title = 'PREMIUL 2'; titleClass = 'award-silver'; showInput = true; } 
else if (score === 90) { icon = 'ü•â'; title = 'PREMIUL 3'; titleClass = 'award-bronze'; showInput = true; } 
else if (score >= 70 && score <= 85) { icon = 'üéñÔ∏è'; title = 'MEN»öIUNE'; titleClass = 'award-mention'; showInput = true; } 
else { icon = 'üí™'; title = '√éNCEARCƒÇ DIN NOU'; titleClass = 'award-try'; showInput = false; }
awardIcon.textContent = icon;
awardTitle.textContent = title;
awardTitle.className = 'award-title ' + titleClass;
if(showInput) { nameInputGroup.style.display = 'flex'; closeAwardBtn.style.display = 'none'; playerNameInput.value = ''; playerNameInput.focus(); } 
else { nameInputGroup.style.display = 'none'; closeAwardBtn.style.display = 'inline-block'; }
}

function saveScore() {
const name = playerNameInput.value.trim() || "Anonim";
const leaderboardKey = `math_leaderboard_${currentMode}`;
try {
let scores = JSON.parse(localStorage.getItem(leaderboardKey) || "[]");
scores.push({ name: name, score: score, date: new Date().toLocaleDateString() });
scores.sort((a, b) => b.score - a.score);
scores = scores.slice(0, 10);
localStorage.setItem(leaderboardKey, JSON.stringify(scores));
nameInputGroup.style.display = 'none';
closeAwardBtn.style.display = 'inline-block';
} catch (e) {
console.error("Eroare la salvarea scorului:", e);
alert("A apƒÉrut o eroare la salvarea scorului. Te rugƒÉm sƒÉ √Æncerci din nou.");
// Afi»ôeazƒÉ eroarea »ôi pe ecran prin handler-ul global
throw e; 
}
}

function showLeaderboard(categoryKey) {
const key = categoryKey || currentSubMenuKey;
const menuData = menus[key];
if (!menuData) { console.error("Categorie invalidƒÉ:", key); return; }
gameArea.style.display = 'none';
awardScreen.style.display = 'none';
subMenu.style.display = 'none';
mainMenu.style.display = 'none';
leaderboardScreen.style.display = 'flex';
backBtn.style.display = 'flex';
backBtn.onclick = () => { leaderboardScreen.style.display = 'none'; if(categoryKey) mainMenu.style.display = 'block'; else subMenu.style.display = 'block'; };
leaderboardTitle.textContent = `Clasament: ${menuData.title}`;
let allScores = [];
if (menuData.items && Array.isArray(menuData.items)) {
menuData.items.forEach(item => {
try {
const itemKey = `math_leaderboard_${item.id}`;
const itemScores = JSON.parse(localStorage.getItem(itemKey) || "[]");
allScores = allScores.concat(itemScores);
} catch (e) { console.warn(`Eroare la citirea scorurilor pentru ${item.id}:`, e); }
});
}
allScores.sort((a, b) => b.score - a.score);
allScores = allScores.slice(0, 10);
leaderboardBody.innerHTML = '';
if(allScores.length === 0) { leaderboardBody.innerHTML = '<tr><td colspan="3">Nu existƒÉ √ÆncƒÉ scoruri.</td></tr>'; } 
else {
allScores.forEach((entry, index) => {
const row = `<tr><td>${index + 1}</td><td>${entry.name}</td><td>${entry.score}</td></tr>`;
leaderboardBody.innerHTML += row;
});
}
}

function showCorrectAnswer() {
if(problemHTML) {
const correctedHTML = problemHTML.replace(/<span class="missing-number">\?<\/span>/g, `<span style="color:var(--success)">${currentAnswer}</span>`);
gameContent.innerHTML = correctedHTML;
}
feedbackText.innerHTML = `Gre»ôit. <br>RƒÉspunsul corect era <strong>${currentAnswer}</strong>. (-5 puncte)`;
feedbackText.className = "feedback wrong";
score -= 5;
updateStats();
difficultyLevel++;
answerInput.value = '';
setTimeout(nextProblem, 2500);
}

function checkAnswer() {
const isBoy = currentMode.startsWith('kg');
if(isBoy) return;
const userVal = parseFloat(answerInput.value);
if (isNaN(userVal)) return;
if(currentMode === 'easy_comp') {
if(userVal === currentAnswer) {
feedbackText.textContent = "Bravo! Corect! üéâ";
feedbackText.className = "feedback correct";
difficultyLevel = 1;
setTimeout(nextProblem, 1500);
} else { showCorrectAnswer(); }
return;
}
if (Math.abs(userVal - currentAnswer) < 0.01) {
feedbackText.textContent = "Bravo! E»ôti campion! üéâ";
feedbackText.className = "feedback correct";
difficultyLevel = 1;
setTimeout(nextProblem, 1500);
} else {
showCorrectAnswer();
}
}

init();
</script>
</body>
</html>